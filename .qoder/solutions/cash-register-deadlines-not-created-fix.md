# РЕШЕНИЕ: Не создавались автоматические дедлайны для ККТ

## Проблема
После сохранения карточки ККТ с заполненными полями "Дата замены ФН" и "Дата продления ОФД" не создавались автоматические дедлайны.

## Причина
**Несоответствие названия типа дедлайна между кодом и базой данных:**

В сервисе (код):
```python
OFD_RENEWAL_TYPE = "Продление договора"
```

В базе данных:
```
ID: 4, Название: "Продление договора ОФД"
```

Сервис искал тип с названием "Продление договора", но не находил его, поэтому дедлайны для продления ОФД не создавались.

## Решение

### Исправлена константа в сервисе
```python
# web/app/services/cash_register_deadline_service.py, строка 23
OFD_RENEWAL_TYPE = "Продление договора ОФД"  # Точное название из БД
```

## Как проверить работу

### 1. Перезапустить веб-сервер
**ВАЖНО!** Изменения вступят в силу только после перезапуска сервера.

```powershell
# Остановить текущий сервер (Ctrl+C в окне где запущен)
# Затем запустить заново:
cd d:\QoProj\KKT
.\start_web.bat
```

### 2. Тестовое сохранение кассы
1. Откройте веб-интерфейс: http://localhost:8000/static/dashboard.html
2. Перейдите в раздел "Клиенты"
3. Выберите любого клиента и откройте его карточку
4. Добавьте или измените кассовый аппарат:
   - Укажите "Дата замены ФН" (например, через месяц)
   - Укажите "Дата продления ОФД" (например, через 2 месяца)
5. Сохраните

### 3. Проверка созданных дедлайнов
```powershell
cd d:\QoProj\KKT
python test_cash_register_deadline_creation.py
```

Должны увидеть:
```
✅ Тип 'Замена ФН' найден: ID=6
✅ Тип 'Продление договора ОФД' найден: ID=4

Касса ID=X: Название кассы
  Дата замены ФН: 2026-01-15
  Дата продления ОФД: 2026-02-15
  Найдено активных дедлайнов: 2
    - Замена ФН: 2026-01-15
    - Продление договора ОФД: 2026-02-15
  ✅ Дедлайн 'Замена ФН' совпадает
  ✅ Дедлайн 'Продление договора ОФД' совпадает
```

## Типы дедлайнов в системе

Актуальные типы в базе данных:
- ID 1: "Регистрация ККТ"
- ID 3: "Техническое обслуживание"
- ID 4: "Продление договора ОФД" ✅ используется для автоматических дедлайнов
- ID 5: "ИТС 1С (Инженерно техническое обслуживание)"
- ID 6: "Замена ФН" ✅ используется для автоматических дедлайнов

## Изменённые файлы
- `web/app/services/cash_register_deadline_service.py` (строка 23)

## Результат
✅ Теперь при сохранении карточки ККТ автоматически создаются оба дедлайна:
- "Замена ФН" - если заполнено поле "Дата замены ФН"
- "Продление договора ОФД" - если заполнено поле "Дата продления ОФД"

✅ При обновлении дат в карточке ККТ - дедлайны автоматически обновляются
✅ При удалении дат из карточки ККТ - дедлайны переходят в статус 'cancelled'
