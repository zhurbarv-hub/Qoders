# ⚠️ ТРЕБУЕТСЯ ПЕРЕЗАПУСК СЕРВЕРА

## Проблема
Дедлайн при изменении даты продления договора ОФД все равно автоматически не создался.

## Причина
**Веб-сервер НЕ БЫЛ ПЕРЕЗАПУЩЕН после исправления кода!**

Сервер был запущен: **13.12.2025 21:21:23**  
Исправление кода было сделано: **позже**

Python загружает модули при старте приложения. Изменения в коде вступают в силу **только после перезапуска сервера**.

## Решение

### ВАРИАНТ 1: Автоматический перезапуск (Рекомендуется)

Запустите скрипт перезапуска:
```batch
cd d:\QoProj\KKT
restart_web_server.bat
```

Этот скрипт:
1. Остановит текущий сервер
2. Подождет 2 секунды
3. Запустит сервер заново в новом окне

### ВАРИАНТ 2: Ручной перезапуск

1. **Остановить текущий сервер:**
   - Найдите окно PowerShell с запущенным сервером
   - Нажмите `Ctrl+C`
   - ИЛИ выполните: `taskkill /F /IM uvicorn.exe`

2. **Запустить сервер заново:**
   ```batch
   cd d:\QoProj\KKT
   .\start_web.bat
   ```

### ВАРИАНТ 3: PowerShell одной командой

```powershell
Get-Process -Name uvicorn | Stop-Process -Force
cd d:\QoProj\KKT
.\start_web.bat
```

## Проверка работы

После перезапуска сервера:

### 1. Откройте веб-интерфейс
http://localhost:8000/static/dashboard.html

### 2. Протестируйте создание дедлайна
1. Перейдите в раздел **"Клиенты"**
2. Выберите любого клиента
3. Откройте его карточку (кнопка с иконкой dashboard)
4. Найдите любую кассу или создайте новую
5. **Измените дату продления ОФД** (например, на месяц вперед)
6. Нажмите **"Сохранить"**

### 3. Проверьте созданный дедлайн
В разделе **"Дедлайны по кассам"** должен появиться новый дедлайн:
- Тип: **"Продление договора ОФД"**
- Дата истечения: та же, что вы указали в поле "Дата продления ОФД"
- Примечание: "Автоматически создано из карточки ККТ..."

### 4. Автоматическая проверка через скрипт
```powershell
cd d:\QoProj\KKT
python test_cash_register_deadline_creation.py
```

Должны увидеть:
```
✅ Тип 'Замена ФН' найден: ID=6
✅ Тип 'Продление договора ОФД' найден: ID=4

Касса ID=X: Название кассы
  ✅ Дедлайн 'Замена ФН' совпадает
  ✅ Дедлайн 'Продление договора ОФД' совпадает
```

## Почему это произошло?

Python - интерпретируемый язык, но FastAPI загружает все модули при запуске:

1. При запуске `uvicorn` загружает все Python файлы в память
2. Создается экземпляр приложения FastAPI
3. Импортируются все модули, включая `CashRegisterDeadlineService`
4. Константа `OFD_RENEWAL_TYPE` загружается в память

**Изменения в файлах НЕ влияют на работающий процесс!**

Только после перезапуска новый процесс загрузит обновленный код.

## В будущем

При любых изменениях в коде Python **всегда перезапускайте сервер** для применения изменений.

Исключения:
- ✅ Изменения в HTML/CSS/JavaScript - перезапуск НЕ нужен (просто обновите страницу в браузере)
- ❌ Изменения в Python (.py файлах) - перезапуск ОБЯЗАТЕЛЕН

## Проверка применения изменений

Проверить, что сервер загрузил исправленный код:
```powershell
cd d:\QoProj\KKT
python -c "from web.app.services.cash_register_deadline_service import CashRegisterDeadlineService; print(CashRegisterDeadlineService.OFD_RENEWAL_TYPE)"
```

Должно вывести: `Продление договора ОФД`

Если выводит `Продление договора` (без "ОФД") - код НЕ загружен.
