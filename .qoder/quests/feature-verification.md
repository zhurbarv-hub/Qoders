# Верификация функционала: Недоработки в сохранении данных ККТ

## Идентифицированная проблема

**Описание**: При редактировании кассового аппарата (ККТ) через карточку клиента не сохраняются поля "Название кассы" и "Адрес установки", несмотря на то, что они были внесены при первичном добавлении ККТ.

**Источник**: Обнаружено в процессе тестирования функционала на production-сервере (VDS).

**Критичность**: Средняя
- Функция добавления ККТ может работать частично
- Потеря важных пользовательских данных при редактировании
- Влияет на полноту информации о кассовых аппаратах клиентов

---

## Анализ первопричины

### 1. Несоответствие между Frontend и Backend схемами

**Frontend** (файл: `web/app/static/js/client-details.js`, строки 813-820)

Форма редактирования/создания ККТ отправляет следующие поля:
- `register_name` — Название кассы (обязательное поле в UI)
- `model` — Модель ККТ (обязательное поле в UI)
- `factory_number` — Заводской номер
- `fn_number` — Номер ФН
- `ofd_provider_id` — ID провайдера ОФД
- `notes` — Примечания
- `fn_expiry_date` — Дата окончания ФН
- `ofd_expiry_date` — Дата окончания договора с ОФД

**Backend API** (файл: `web/app/api/cash_registers.py`)

Схемы `CashRegisterCreate` (строки 36-48) и `CashRegisterUpdate` (строки 50-62) **не содержат** поле `register_name`.

Схема `CashRegisterCreate` содержит только:
- `client_id`
- `factory_number`
- `registration_number`
- `model`
- `fn_number`
- `ofd_provider_id`
- `ofd_contract_date`
- `ofd_expiry_date`
- `fn_expiry_date`
- `registration_expiry_date`
- `notes`

### 2. Отсутствие поля в модели базы данных

**Модель БД** (файл: `web/app/models/cash_register.py`, строки 12-38)

Таблица `cash_registers` **не содержит** столбцов:
- `register_name` — для хранения названия кассы
- `installation_address` — для хранения адреса установки

При этом в UI присутствуют оба поля:
- Поле "Название кассы" (`registerName`) — обязательное
- Поле "Адрес установки" (`installationAddress`) — опциональное

### 3. Устаревший код в форме редактирования

В JavaScript-коде (строка 767):
```javascript
document.getElementById('installationAddress').value = '';  // Это поле больше не используется
```

Комментарий указывает, что поле устарело, но оно всё ещё присутствует в HTML-форме (строки 518-527 в `client-details.html`).

---

## Последствия проблемы

### Сценарий 1: Создание новой кассы
1. Пользователь заполняет форму создания ККТ, включая "Название кассы" и "Адрес установки"
2. Frontend отправляет данные, включая `register_name`
3. Backend игнорирует `register_name` (не определено в схеме Pydantic)
4. Касса создаётся **без названия** — используется только поле `model`
5. Поле "Адрес установки" полностью игнорируется

### Сценарий 2: Редактирование существующей кассы
1. Пользователь открывает карточку редактирования ККТ
2. Поле "Название кассы" загружается из `register.register_name` (которое отсутствует в БД → пустое)
3. Поле "Адрес установки" принудительно очищается (строка 767)
4. Пользователь изменяет другие данные и сохраняет
5. Название и адрес не сохраняются

### Влияние на отображение данных
- В списке касс отображается только `model` (строка 252 в `client-details.js`)
- Если `model` пустое, показывается "Касса" (дефолтное значение)
- Информация об адресе установки полностью теряется

---

## Выявленные архитектурные несоответствия

### 1. Дублирование концепций
- `model` (Модель ККТ) — техническая характеристика (например, "ЭККАР 54-ФР")
- `register_name` (Название кассы) — пользовательское имя (например, "Касса №1 на складе")

**Проблема**: UI требует оба поля, но Backend и БД поддерживают только `model`

### 2. Устаревшие поля
Поле `installation_address` присутствует в:
- HTML-форме (`client-details.html`)
- Схемах-заглушках (`cash_register_schemas.py`, `client_schemas.py`)

Но **отсутствует** в:
- Рабочей модели БД (`cash_register.py`)
- API-схемах (`cash_registers.py`)

### 3. Несогласованность наименований

| UI элемент | JavaScript переменная | API поле | БД столбец |
|------------|----------------------|----------|------------|
| Название кассы | `registerName` | `register_name` | ❌ отсутствует |
| Модель ККТ | `registerModel` | `model` | `model` |
| Адрес установки | `installationAddress` | ❌ игнорируется | ❌ отсутствует |

---

## Варианты решения

### Вариант 1: Добавить недостающие поля в Backend и БД ✅ Рекомендуемый

**Обоснование**: UI уже реализован и соответствует бизнес-требованиям

**Действия**:

1. **Миграция БД**: Добавить столбцы в таблицу `cash_registers`
   - `register_name VARCHAR(255)` — название кассы
   - `installation_address TEXT` — адрес установки

2. **Обновление модели SQLAlchemy** (`web/app/models/cash_register.py`)
   - Добавить поля `register_name` и `installation_address`

3. **Обновление Pydantic-схем** (`web/app/api/cash_registers.py`)
   - `CashRegisterCreate`: добавить `register_name` (обязательное), `installation_address` (опциональное)
   - `CashRegisterUpdate`: добавить оба поля как опциональные
   - `CashRegisterResponse`: добавить оба поля

4. **Обновление логики создания/обновления**
   - В endpoint `create_cash_register` (строка 120): использовать `register_name` для создания дедлайнов вместо `model`
   - В endpoint `update_cash_register` (строка 184): аналогично

**Преимущества**:
- Минимальные изменения в коде
- Сохраняется текущая логика UI
- Решает проблему полностью

**Риски**:
- Требуется миграция БД на production

---

### Вариант 2: Удалить устаревшие поля из UI ❌ Не рекомендуется

**Действия**:
1. Удалить поле "Название кассы" из формы
2. Удалить поле "Адрес установки" из формы
3. Использовать только `model` для идентификации кассы

**Недостатки**:
- Потеря функциональности для пользователей
- Невозможность отличить несколько касс одной модели
- Потеря информации об адресе установки (важно для обслуживания)

---

### Вариант 3: Объединить поля (компромисс) ⚠️ Частичное решение

**Действия**:
1. Сохранить только `model`
2. Удалить `register_name` из формы
3. Добавить `installation_address` в БД и API как опциональное поле

**Преимущества**:
- Меньше изменений в БД

**Недостатки**:
- Всё ещё требует миграции БД
- Теряется возможность дать кассе пользовательское имя

---

## Рекомендуемый план реализации

### Фаза 1: Подготовка миграции БД

**Задача 1.1**: Создать SQL-миграцию
- Файл: `web/migrations/010_add_cash_register_name_and_address.sql`
- Действия:
  ```
  ALTER TABLE cash_registers 
  ADD COLUMN register_name VARCHAR(255),
  ADD COLUMN installation_address TEXT;
  ```

**Задача 1.2**: Создать скрипт для обратной совместимости
- Заполнить `register_name` значением `model` для существующих записей (если `model` заполнено)

---

### Фаза 2: Обновление Backend

**Задача 2.1**: Обновить модель SQLAlchemy
- Файл: `web/app/models/cash_register.py`
- Добавить:
  - `register_name = Column(String(255))` (после строки 20)
  - `installation_address = Column(Text)` (после нового поля)

**Задача 2.2**: Обновить Pydantic-схемы
- Файл: `web/app/api/cash_registers.py`

Схема `CashRegisterCreate`:
- Добавить `register_name: Optional[str] = Field(None, max_length=255, description="Название кассы")`
- Добавить `installation_address: Optional[str] = Field(None, description="Адрес установки")`

Схема `CashRegisterUpdate`:
- Добавить те же поля как опциональные

Схема `CashRegisterResponse`:
- Добавить те же поля для вывода

**Задача 2.3**: Обновить логику создания кассы
- Файл: `web/app/api/cash_registers.py`, функция `create_cash_register` (строка 120)
- Изменить строки 137-148: добавить присваивание `register_name` и `installation_address`
- Изменить строку 160: использовать `register_name` вместо `model` для имени дедлайна (если заполнено)

**Задача 2.4**: Обновить логику редактирования кассы
- Файл: `web/app/api/cash_registers.py`, функция `update_cash_register` (строка 184)
- Изменить строку 231: использовать `register_name` вместо `model` для имени дедлайна (если заполнено)

---

### Фаза 3: Обновление Frontend

**Задача 3.1**: Исправить логику загрузки данных в форму редактирования
- Файл: `web/app/static/js/client-details.js`, функция `editRegister` (строка 754)
- Строка 763: изменить `register.register_name || ''` на корректную загрузку
- Строка 767: удалить принудительную очистку `installationAddress`, заменить на `register.installation_address || ''`

**Задача 3.2**: Проверить логику отображения касс
- Файл: `web/app/static/js/client-details.js`, функция `renderCashRegisters` (строка 221)
- Строка 252: рассмотреть возможность отображения `register_name` вместо/дополнительно к `model`

**Задача 3.3**: Обновить отображение адреса установки
- Добавить адрес установки в карточку кассы (если заполнен)

---

### Фаза 4: Тестирование

**Тест 1**: Создание новой кассы с заполненными полями
- Ожидание: все поля сохраняются корректно
- Проверка: данные появляются в БД, отображаются в карточке клиента

**Тест 2**: Редактирование существующей кассы
- Ожидание: поля "Название кассы" и "Адрес установки" загружаются из БД и сохраняются при изменении
- Проверка: изменения применяются в БД

**Тест 3**: Обратная совместимость
- Ожидание: старые кассы (без `register_name`) корректно отображаются
- Проверка: используется fallback на `model`

**Тест 4**: Автоматическое создание дедлайнов
- Ожидание: при создании/редактировании кассы дедлайны создаются с корректным именем (из `register_name` или `model`)
- Проверка: имя дедлайна соответствует названию кассы

---

## Критерии приёмки

### Функциональные требования
1. ✅ При создании ККТ поле "Название кассы" сохраняется в БД
2. ✅ При создании ККТ поле "Адрес установки" сохраняется в БД
3. ✅ При редактировании ККТ оба поля загружаются из БД в форму
4. ✅ При редактировании ККТ изменения в обоих полях сохраняются
5. ✅ Карточка кассы отображает название и адрес (если заполнены)
6. ✅ Автоматически создаваемые дедлайны используют название кассы (если заполнено)

### Технические требования
1. ✅ Миграция БД выполняется без ошибок
2. ✅ API возвращает новые поля в ответах
3. ✅ Валидация Pydantic корректно обрабатывает новые поля
4. ✅ Нет ошибок в консоли браузера
5. ✅ Обратная совместимость: старые записи без новых полей работают корректно

### Нефункциональные требования
1. ✅ Время отклика API не увеличивается более чем на 5%
2. ✅ Миграция БД выполняется менее чем за 1 секунду
3. ✅ Размер ответа API увеличивается не более чем на 200 байт на запись

---

## Риски и зависимости

### Риски
1. **Риск потери данных при миграции**: Средний
   - Митигация: резервная копия БД перед миграцией
   
2. **Риск несовместимости с существующими клиентами**: Низкий
   - Митигация: новые поля опциональны, старые данные работают без изменений

3. **Риск ошибок в автоматическом создании дедлайнов**: Низкий
   - Митигация: использовать fallback на `model` если `register_name` пустое

### Зависимости
1. Доступ к production БД для применения миграции
2. Возможность перезапуска backend-сервиса (кратковременный downtime ~30 сек)
3. Координация с тестировщиками для проверки на VDS

---

## Дополнительные замечания

### Обнаруженные связанные проблемы
1. Поле `registration_number` присутствует в API-схемах, но не используется в UI
2. Устаревшие схемы в `cash_register_schemas.py` могут вводить в заблуждение

### Рекомендации по улучшению
1. Провести аудит всех моделей и схем на соответствие UI/API/БД
2. Удалить устаревшие файлы схем для предотвращения путаницы
3. Добавить комментарии в код о назначении каждого поля
4. Рассмотреть возможность добавления unit-тестов для валидации схем

---

## История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-12-14 | 1.0 | Первичный анализ проблемы, предложенные решения |
