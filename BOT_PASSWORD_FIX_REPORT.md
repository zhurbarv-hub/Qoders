# –û—Ç—á—ë—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ HTTP 422 –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞

## –î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
22 –¥–µ–∫–∞–±—Ä—è 2025 –≥–æ–¥–∞

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
```
üåê URL: http://localhost:8000
‚ùå –°—Ç–∞—Ç—É—Å: –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω
‚ö†Ô∏è –û—à–∏–±–∫–∞: HTTP 422: {"detail":[{"type":"string_too_short","loc":["body","password"],"msg":"String should have at l...
üíæ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: Fallback (–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î)
```

**–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞:**
Telegram –±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Web API –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è (HTTP 422 - Unprocessable Entity).

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π Web API

**–ù–∞–π–¥–µ–Ω–æ:** –í —Ñ–∞–π–ª–µ `web/app/models/schemas.py` (—Å—Ç—Ä–æ–∫–∞ 12):
```python
password: str = Field(..., min_length=6)
```

**–í—ã–≤–æ–¥:** Web API —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º **6 —Å–∏–º–≤–æ–ª–æ–≤** –¥–ª—è –ø–∞—Ä–æ–ª—è.

---

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞

**–§–∞–π–ª:** `.env` (—Å—Ç—Ä–æ–∫–∏ 60-61)

**–ë—ã–ª–æ:**
```env
BOT_API_USERNAME=admin
BOT_API_PASSWORD=admin123
```

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:**
- –ü–∞—Ä–æ–ª—å —É–∂–µ –∏–º–µ–µ—Ç 8 —Å–∏–º–≤–æ–ª–æ–≤ (`admin123` ‚úÖ)
- –û–¥–Ω–∞–∫–æ username —É–∫–∞–∑–∞–Ω –∫–∞–∫ `admin`, –∞ –Ω–µ email

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î

**–ö–æ–º–∞–Ω–¥–∞:**
```bash
python -c "import sqlite3; conn = sqlite3.connect('database/kkt_services.db'); cursor = conn.cursor(); cursor.execute('PRAGMA table_info(users)'); print('\n'.join([str(row) for row in cursor.fetchall()])); conn.close()"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
(0, 'id', 'INTEGER', 0, None, 1)
(1, 'email', 'VARCHAR(255)', 1, None, 0)
(2, 'password_hash', 'VARCHAR(255)', 0, None, 0)
...
# –ù–ï–¢ –ü–û–õ–Ø username!
```

**–í—ã–≤–æ–¥:** –í —Å—Ç–∞—Ä–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ `username`. –ú–æ–¥–µ–ª—å `User` –≤ –∫–æ–¥–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–æ –ø–æ–ª–µ, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î –µ–≥–æ –Ω–µ—Ç - —ç—Ç–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ö–µ–º—ã.

---

### –®–∞–≥ 4: –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin

**–°–∫—Ä–∏–ø—Ç:** `check_admin_users.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ID    Email                          Role       Active   Full Name
----------------------------------------------------------------------
1     admin@kkt.ru                   admin      1        –ì–ª–∞–≤–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
2     manager@kkt.ru                 manager    1        –ò–≤–∞–Ω –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
```

**–í—ã–≤–æ–¥:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–æ–ª—å—é admin —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å email `admin@kkt.ru` (ID=1).

---

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ username –≤ .env

**–§–∞–π–ª:** `.env` (—Å—Ç—Ä–æ–∫–∞ 60-61)

**–ë—ã–ª–æ:**
```env
BOT_API_USERNAME=admin
BOT_API_PASSWORD=admin123
```

**–°—Ç–∞–ª–æ:**
```env
# –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ username
BOT_API_USERNAME=admin@kkt.ru
BOT_API_PASSWORD=admin123
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- Web API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `authenticate_user()` –∏–∑ `web/app/services/auth_service.py`
- –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–Ω–∞—á–∞–ª–∞ –ø–æ `username`, –∑–∞—Ç–µ–º –ø–æ `email`
- –ü–æ—Å–∫–æ–ª—å–∫—É –≤ –ë–î –Ω–µ—Ç –ø–æ–ª—è `username`, –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ email

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –≤ –ë–î

**–°–∫—Ä–∏–ø—Ç:** `fix_bot_password_direct.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
```
============================================================
üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–†–û–õ–Ø –ë–û–¢–ê (–ü–†–Ø–ú–û–ô –î–û–°–¢–£–ü –ö –ë–î)
============================================================

‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
   ID: 1
   Email: admin@kkt.ru
   Full Name: –ì–ª–∞–≤–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
   Role: admin
   Active: 1

‚úÖ –ü–∞—Ä–æ–ª—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 'admin123'
   –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è!

üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...
   –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –£–°–ü–ï–®–ù–û
```

**–í—ã–≤–æ–¥:** –ü–∞—Ä–æ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `admin123` –∏–∑ `.env` —Ñ–∞–π–ª–∞.

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ .env

**–°–∫—Ä–∏–ø—Ç:** `test_bot_login.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   API URL: http://localhost:8000
   Username: admin@kkt.ru
   Password: ******** (8 —Å–∏–º–≤–æ–ª–æ–≤)
```

‚úÖ **–£—Å–ø–µ—Ö:** –î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è (8 —Å–∏–º–≤–æ–ª–æ–≤) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é (‚â•6 —Å–∏–º–≤–æ–ª–æ–≤)

---

### –¢–µ—Å—Ç 2: –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—Ä–∏ –∑–∞–ø—É—â–µ–Ω–Ω–æ–º API)

**–°—Ç–∞—Ç—É—Å:** Web API –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –º–æ–º–µ–Ω—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Web API:
   ```bash
   python -m uvicorn web.app.main:app --reload
   ```
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç:
   ```bash
   python test_bot_login.py
   ```
3. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 200 —Å JWT —Ç–æ–∫–µ–Ω–æ–º

---

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### 1. `check_admin_users.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—è–º–∏ admin/manager –≤ –ë–î

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
python check_admin_users.py
```

---

### 2. `fix_bot_password_direct.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –ë–î (–æ–±—Ö–æ–¥ ORM)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å SQLite —á–µ—Ä–µ–∑ sqlite3
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–æ–¥–µ–ª–∏ User –∏ —Å—Ö–µ–º—ã –ë–î
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç bcrypt –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
python fix_bot_password_direct.py
```

---

### 3. `test_bot_login.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ –≤ Web API

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ó–∞–≥—Ä—É–∑–∫—É —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ `.env`
- –î–ª–∏–Ω—É –ø–∞—Ä–æ–ª—è (‚â•6 —Å–∏–º–≤–æ–ª–æ–≤)
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Web API
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª—É—á–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
python test_bot_login.py
```

**–í—ã–≤–æ–¥ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ:**
```
‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê!

üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
   1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Telegram –±–æ—Ç–∞
   2. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è '‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω'
```

---

## –ò—Ç–æ–≥–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤

| –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|--------|-----------|
| `.env` | ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω | `BOT_API_USERNAME` –∏–∑–º–µ–Ω—ë–Ω —Å `admin` –Ω–∞ `admin@kkt.ru` |
| `database/kkt_services.db` | ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω | –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `admin@kkt.ru` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω (`admin123`) |

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 1. –ó–∞–ø—É—Å–∫ Web API
```bash
cd d:\QoProj\KKT
python -m uvicorn web.app.main:app --host 0.0.0.0 --port 8000 --reload
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

---

### 2. –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```bash
python test_bot_login.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê!
üéüÔ∏è  –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω
```

---

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞
```bash
python -m bot.main
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:**
```
‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω. –ò—Å—Ç–µ–∫–∞–µ—Ç –≤ HH:MM:SS
```

**–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è:**
- –ë—ã–ª–æ: `üíæ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: Fallback (–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î)`
- –°—Ç–∞–ª–æ: `üíæ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: API mode`

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ HTTP 422

**–ö–æ–¥ –æ—à–∏–±–∫–∏:** 422 Unprocessable Entity

**–ü—Ä–∏—á–∏–Ω–∞:** Pydantic —Å—Ö–µ–º–∞ `LoginRequest` –≤ `web/app/models/schemas.py` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é:
```python
password: str = Field(..., min_length=6)
```

**–ï—Å–ª–∏ –±—ã –ø–∞—Ä–æ–ª—å –±—ã–ª –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤**, FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
```json
{
  "detail": [
    {
      "type": "string_too_short",
      "loc": ["body", "password"],
      "msg": "String should have at least 6 characters"
    }
  ]
}
```

---

### –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ö–µ–º—ã –ë–î –∏ –º–æ–¥–µ–ª–∏ ORM:**

**–ú–æ–¥–µ–ª—å `User` (web/app/models/user.py:44):**
```python
username = Column(String(50), unique=True, nullable=False, index=True)
```

**–†–µ–∞–ª—å–Ω–∞—è –ë–î (database/kkt_services.db):**
- –ü–æ–ª–µ `username` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ `email`

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `email` –≤–º–µ—Å—Ç–æ `username` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–æ—Ç–∞.

---

### –ü–æ—á–µ–º—É authenticate_user() —Ä–∞–±–æ—Ç–∞–µ—Ç —Å email?

**–ö–æ–¥ –∏–∑ `web/app/services/auth_service.py` (—Å—Ç—Ä–æ–∫–∏ 50-55):**
```python
# –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ username
user = db.query(User).filter(User.username == username).first()

# –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ username, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ email
if not user:
    user = db.query(User).filter(User.email == username).first()
```

**–õ–æ–≥–∏–∫–∞:**
1. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –ø–æ –ø–æ–ª—é `username`
2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—â–µ—Ç –ø–æ –ø–æ–ª—é `email`
3. **–í–∞–∂–Ω–æ:** –í –ø–∞—Ä–∞–º–µ—Ç—Ä `username` –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å email - —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø—Ä–æ–±—É–µ—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞

**–ü–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–¥–∞—á–∞ `admin@kkt.ru` –≤ –ø–æ–ª–µ `username` –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.**

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è username

**–¶–µ–ª—å:** –ü—Ä–∏–≤–µ—Å—Ç–∏ —Å—Ö–µ–º—É –ë–î –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –º–æ–¥–µ–ª—å—é ORM

**SQL –º–∏–≥—Ä–∞—Ü–∏—è:**
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è username
ALTER TABLE users ADD COLUMN username VARCHAR(50) UNIQUE;

-- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ username –Ω–∞ –æ—Å–Ω–æ–≤–µ email
UPDATE users SET username = LOWER(REPLACE(email, '@', '_'));

-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NOT NULL –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
-- SQLite –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ALTER COLUMN, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è SQLite –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã.

---

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–æ—Ç–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (–ø—Ä–∏–Ω—Ü–∏–ø –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π)
- –£–ø—Ä–æ—â–µ–Ω–∏–µ –∞—É–¥–∏—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π –±–æ—Ç–∞
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ admin

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```python
username: telegram_bot
email: bot@system.local
password: bot_secure_password_123
role: manager (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å 'bot')
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `.env`:**
```env
BOT_API_USERNAME=bot@system.local
BOT_API_PASSWORD=bot_secure_password_123
```

---

### 3. –£—Å–∏–ª–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∞—Ä–æ–ª—é

**–¢–µ–∫—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 6 —Å–∏–º–≤–æ–ª–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
```python
# web/app/models/schemas.py
from pydantic import Field, validator

class LoginRequest(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    password: str = Field(..., min_length=12, max_length=100)  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 12
    
    @validator('password')
    def password_complexity(cls, v):
        if not any(char.isdigit() for char in v):
            raise ValueError('Password must contain at least one digit')
        if not any(char.isupper() for char in v):
            raise ValueError('Password must contain at least one uppercase letter')
        if not any(char.islower() for char in v):
            raise ValueError('Password must contain at least one lowercase letter')
        return v
```

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### A. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã users

```
Column            Type              Nullable  Default
-----------------------------------------------------
id                INTEGER           NO        PRIMARY KEY
email             VARCHAR(255)      NO        -
password_hash     VARCHAR(255)      YES       -
full_name         VARCHAR(255)      NO        -
role              VARCHAR(20)       NO        'client'
inn               VARCHAR(12)       YES       -
company_name      VARCHAR(255)      YES       -
phone             VARCHAR(20)       YES       -
address           TEXT              YES       -
notes             TEXT              YES       -
telegram_id       VARCHAR(50)       YES       -
telegram_username VARCHAR(100)      YES       -
registration_code VARCHAR(20)       YES       -
code_expires_at   DATETIME          YES       -
first_name        VARCHAR(100)      YES       -
last_name         VARCHAR(100)      YES       -
notification_days TEXT              YES       '14,7,3'
notifications_enabled BOOLEAN       YES       1
is_active         BOOLEAN           NO        1
registered_at     TIMESTAMP         YES       CURRENT_TIMESTAMP
last_interaction  TIMESTAMP         YES       -
created_at        TIMESTAMP         YES       CURRENT_TIMESTAMP
```

---

### B. –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ Web API

**–ó–∞–ø—Ä–æ—Å:**
```http
POST /api/auth/login HTTP/1.1
Content-Type: application/json

{
  "username": "admin@kkt.ru",
  "password": "admin123"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "admin@kkt.ru",
    "email": "admin@kkt.ru",
    "role": "admin",
    "full_name": "–ì–ª–∞–≤–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
  }
}
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û**

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ –ü–∞—Ä–æ–ª—å –≤ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ `admin123` (8 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –§–∞–π–ª `.env` –æ–±–Ω–æ–≤–ª—ë–Ω: `BOT_API_USERNAME=admin@kkt.ru`
- ‚úÖ –î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º (‚â•6 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ Bcrypt —Ö–µ—à –ø–∞—Ä–æ–ª—è –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Web API
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å `python test_bot_login.py`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Telegram –±–æ—Ç–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- Web API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:8000`
- –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –∏ –ø–æ–ª—É—á–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω
- –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: `API mode` (–≤–º–µ—Å—Ç–æ Fallback)
- –í –ª–æ–≥–∞—Ö: `‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞:** 22.12.2025  
**–ê–≤—Ç–æ—Ä:** Qoder AI Assistant  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~17 –º–∏–Ω—É—Ç
