# -*- coding: utf-8 -*-
"""
–û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram –±–æ—Ç–∞
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∫–æ–º–∞–Ω–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
"""

from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command
from bot.services.formatter import format_welcome_message, format_help_message
import logging

logger = logging.getLogger(__name__)

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—â–∏—Ö –∫–æ–º–∞–Ω–¥
router = Router()


@router.message(Command("start"))
async def cmd_start(message: Message, user_role: str = 'unknown', **kwargs):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ
    
    Args:
        message (Message): –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        user_role (str): –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ middleware
    """
    try:
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        welcome_text = format_welcome_message(user_role)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await message.answer(welcome_text, parse_mode="HTML")
        
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} (—Ä–æ–ª—å: {user_role}) –ø–æ–ª—É—á–∏–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /start: {e}")
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã")


@router.message(Command('help'))
async def cmd_help(message: Message, user_role: str = 'unknown', **kwargs):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º —Å —É—á—ë—Ç–æ–º —Ä–æ–ª–∏
    """
    user = message.from_user
    logger.info(f"üìñ /help –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} (—Ä–æ–ª—å: {user_role})")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø—Ä–∞–≤–∫—É —Å —É—á—ë—Ç–æ–º —Ä–æ–ª–∏
    help_text = "<b>üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –±–æ—Ç–∞</b>\n\n"
    
    # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
    help_text += "<b>üîπ –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
    help_text += "/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
    help_text += "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
    help_text += "/next - –ë–ª–∏–∂–∞–π—à–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã\n\n"
    
    # –ö–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    help_text += "<b>üîπ –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ–¥–ª–∞–π–Ω–æ–≤:</b>\n"
    help_text += "/list - –í—Å–µ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã\n"
    help_text += "/today - –î–µ–¥–ª–∞–π–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
    help_text += "/week - –î–µ–¥–ª–∞–π–Ω—ã –Ω–∞ –Ω–µ–¥–µ–ª—é\n\n"
    
    # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
    if user_role in ['admin', 'manager']:
        help_text += "<b>üîπ –ö–æ–º–∞–Ω–¥—ã –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:</b>\n"
        help_text += "/search &lt;–∑–∞–ø—Ä–æ—Å&gt; - –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –ò–ù–ù/–Ω–∞–∑–≤–∞–Ω–∏—é\n"
        help_text += "/export - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON/CSV)\n\n"
    
    # –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if user_role == 'admin':
        help_text += "<b>üîπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω):</b>\n"
        help_text += "/addclient - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞\n"
        help_text += "/editclient &lt;–ò–ù–ù&gt; - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞\n"
        help_text += "/deleteclient &lt;–ò–ù–ù&gt; - –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞\n\n"
        
        help_text += "<b>üîπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ (–∞–¥–º–∏–Ω –∏ –º–µ–Ω–µ–¥–∂–µ—Ä):</b>\n"
        help_text += "/adddeadline - –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω\n"
        help_text += "/editdeadline &lt;ID&gt; - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω\n"
        help_text += "/deletedeadline &lt;ID&gt; - –£–¥–∞–ª–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω\n\n"
        
        help_text += "<b>üîπ –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω):</b>\n"
        help_text += "/status - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã\n"
        help_text += "/check - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏\n"
        help_text += "/health - –ü—Ä–æ–≤–µ—Ä–∫–∞ Web API\n\n"
    elif user_role == 'manager':
        help_text += "<b>üîπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ (–º–µ–Ω–µ–¥–∂–µ—Ä):</b>\n"
        help_text += "/adddeadline - –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω\n"
        help_text += "/editdeadline &lt;ID&gt; - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω\n\n"
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    help_text += "<i>üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cancel –≤ –ª—é–±–æ–º –¥–∏–∞–ª–æ–≥–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏</i>\n"
    help_text += "<i>üîî –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 14, 7 –∏ 3 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞</i>"
    
    await message.answer(help_text, parse_mode='HTML')


# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
__all__ = ['router']