# Обновление: Фильтрация неактивных клиентов

## Дата: 12.12.2025

## Реализованные функции:

### 1. Фильтр неактивных клиентов
- **По умолчанию**: В списке клиентов отображаются только активные клиенты
- **Чекбокс**: Добавлен чекбокс "Показать неактивных клиентов" для включения неактивных клиентов в список
- **Состояние**: Сохраняется в глобальной переменной `showInactiveUsers` (сбрасывается при перезагрузке страницы)

### 2. Активация/деактивация клиентов
- **Кнопка активации**: Для неактивных клиентов показывается зеленая кнопка с иконкой ✓ (check_circle)
- **Кнопка деактивации**: Для активных клиентов показывается оранжевая кнопка с иконкой ⊘ (block)
- **Подтверждение**: Перед изменением статуса запрашивается подтверждение
- **Уведомление**: После успешного изменения статуса показывается сообщение

### 3. Backend API

#### Новый endpoint
```
PATCH /api/users/{user_id}/toggle-status
```

**Описание**: Переключает статус активности пользователя (активен ↔ неактивен)

**Доступ**: Только для администраторов

**Защита**: 
- Нельзя изменить статус своей учетной записи
- JWT авторизация обязательна

**Ответ**:
```json
{
  "message": "Пользователь 'Название' активирован/деактивирован"
}
```

#### Существующий endpoint с фильтром
```
GET /api/users?role=client&is_active=true
```

**Параметры**:
- `is_active` (optional, boolean): Фильтр по активности
  - `true` - только активные
  - `false` - только неактивные
  - не указан - все клиенты

## Изменённые файлы:

### Backend
1. **`web/app/api/users.py`**
   - Добавлен endpoint `toggle_user_status()` (PATCH `/users/{user_id}/toggle-status`)
   - Существующий фильтр `is_active` уже был реализован

### Frontend
2. **`web/app/static/js/users.js`** (v4.11)
   - Добавлена глобальная переменная `showInactiveUsers`
   - Добавлена функция `toggleShowInactive()` для переключения фильтра
   - Обновлена функция `loadUsersData()` с поддержкой параметра `is_active`
   - Добавлена функция `toggleUserStatus()` для активации/деактивации
   - Обновлена функция `renderUsersTable()` с чекбоксом и кнопками активации

3. **`web/app/static/dashboard.html`**
   - Обновлена версия users.js до v4.11 для кэш-бастинга

## Тестирование:

### Автоматические тесты
Создан скрипт `test_user_toggle.py` для проверки:
- Получения только активных клиентов
- Получения всех клиентов
- Доступности endpoint переключения статуса

### Результаты тестов
```
✓ Авторизация успешна
✓ ТЕСТ 1: Получение только активных клиентов - 6 клиентов
✓ ТЕСТ 2: Получение всех клиентов - 7 клиентов (1 неактивный)
✓ ТЕСТ 3: Endpoint /users/{user_id}/toggle-status готов к использованию
✓ Все тесты пройдены успешно!
```

## Использование:

### Для пользователя
1. Откройте раздел "Клиенты" в панели управления
2. По умолчанию отображаются только активные клиенты
3. Для просмотра неактивных клиентов отметьте чекбокс "Показать неактивных клиентов"
4. Для активации неактивного клиента нажмите зеленую кнопку ✓ в колонке "Действия"
5. Для деактивации активного клиента нажмите оранжевую кнопку ⊘ в колонке "Действия"
6. Подтвердите действие в диалоговом окне

### Примечания
- Деактивированные клиенты не удаляются из базы данных
- Неактивных клиентов нельзя удалить (кнопка удаления отключена)
- Функционал доступен только администраторам
- После изменения статуса список клиентов автоматически обновляется
