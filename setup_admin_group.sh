#!/bin/bash
# –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Chat ID Telegram-–≥—Ä—É–ø–ø—ã
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./setup_admin_group.sh

echo "============================================================"
echo "  –ë–´–°–¢–†–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ì–†–£–ü–ü–´ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–û–í"
echo "============================================================"
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ VDS
if [ ! -d "/home/kktapp/kkt-system" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ VDS${NC}"
    echo "   –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
    exit 1
fi

echo -e "${YELLOW}üìã –®–∞–≥–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:${NC}"
echo ""
echo "1. –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É '–û–±—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ö–ö–¢' –≤ Telegram"
echo "2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –∏ —Å–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
echo "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É"
echo ""
echo -e "${YELLOW}–ù–∞–∂–º–∏—Ç–µ Enter, –∫–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ —à–∞–≥–∏...${NC}"
read -r

# –ü–æ–ª—É—á–µ–Ω–∏–µ Chat ID
echo ""
echo -e "${GREEN}üîç –ü–æ–ª—É—á–µ–Ω–∏–µ Chat ID –≥—Ä—É–ø–ø—ã...${NC}"
cd /home/kktapp/kkt-system
CHAT_ID_OUTPUT=$(/home/kktapp/kkt-system/venv/bin/python get_group_chat_id.py 2>&1)

# –ü–æ–∏—Å–∫ Chat ID –≤ –≤—ã–≤–æ–¥–µ
CHAT_ID=$(echo "$CHAT_ID_OUTPUT" | grep -oP 'Chat ID: \K-?\d+' | head -1)

if [ -z "$CHAT_ID" ]; then
    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Chat ID${NC}"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "  ‚Ä¢ –ë–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É"
    echo "  ‚Ä¢ –ë–æ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã"
    echo "  ‚Ä¢ –í –≥—Ä—É–ø–ø–µ –Ω–µ –±—ã–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞"
    echo ""
    echo "–í—ã–≤–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞:"
    echo "$CHAT_ID_OUTPUT"
    exit 1
fi

echo -e "${GREEN}‚úÖ Chat ID –ø–æ–ª—É—á–µ–Ω: ${CHAT_ID}${NC}"
echo ""

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞
echo -e "${YELLOW}üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞...${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ ADMIN_GROUP_CHAT_ID –≤ —Ñ–∞–π–ª–µ
if grep -q "^ADMIN_GROUP_CHAT_ID=" /home/kktapp/kkt-system/.env; then
    # –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    sed -i "s/^ADMIN_GROUP_CHAT_ID=.*/ADMIN_GROUP_CHAT_ID=${CHAT_ID}/" /home/kktapp/kkt-system/.env
    echo -e "${GREEN}‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ ADMIN_GROUP_CHAT_ID –æ–±–Ω–æ–≤–ª–µ–Ω–æ${NC}"
else
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    echo "" >> /home/kktapp/kkt-system/.env
    echo "# Chat ID –≥—Ä—É–ø–ø—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤" >> /home/kktapp/kkt-system/.env
    echo "ADMIN_GROUP_CHAT_ID=${CHAT_ID}" >> /home/kktapp/kkt-system/.env
    echo -e "${GREEN}‚úÖ ADMIN_GROUP_CHAT_ID –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env${NC}"
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
echo ""
echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞...${NC}"
systemctl restart kkt-bot.service
sleep 3

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
if systemctl is-active --quiet kkt-bot.service; then
    echo -e "${GREEN}‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞${NC}"
    echo ""
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    echo "  journalctl -u kkt-bot.service -n 50"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo ""
echo "============================================================"
echo -e "${GREEN}  –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê${NC}"
echo "============================================================"
echo ""
echo "üìã –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
echo "  ‚Ä¢ Chat ID –≥—Ä—É–ø–ø—ã: ${CHAT_ID}"
echo "  ‚Ä¢ –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: $(systemctl is-active kkt-bot.service)"
echo ""
echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É!"
echo ""
echo "üß™ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "  1. –ó–∞–π–¥–∏—Ç–µ –≤ –±–æ—Ç–∞ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç"
echo "  2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '‚ùì –ü–æ–º–æ—â—å'"
echo "  3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ"
echo "  4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä—É–ø–ø—É - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
echo ""
