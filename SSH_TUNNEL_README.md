# SSH Tunnel для доступа к VDS KKT

Набор скриптов для создания SSH туннеля и доступа к веб-интерфейсу KKT на VDS.

## Описание

SSH туннель пробрасывает порт **8080** с VDS (185.185.71.248) на локальный компьютер, позволяя работать с веб-интерфейсом через `http://localhost:8080`.

## Файлы

| Файл | Описание |
|------|----------|
| `start_ssh_tunnel.ps1` | Запуск туннеля в текущем окне (блокирующий режим) |
| `start_ssh_tunnel_background.ps1` | Запуск туннеля в новом окне (фоновый режим) |
| `stop_ssh_tunnel.ps1` | Остановка активного туннеля |
| `test_local_api.ps1` | Тест API через туннель |

## Использование

### 1. Запуск туннеля (рекомендуется фоновый режим)

```powershell
# Фоновый режим - запустит туннель в отдельном окне
.\start_ssh_tunnel_background.ps1

# ИЛИ текущее окно - туннель работает пока окно открыто
.\start_ssh_tunnel.ps1
```

При первом запуске:
- Введите пароль от VDS (root)
- Или используйте SSH ключ для автоматического подключения

### 2. Проверка работы

После запуска туннеля:
- Откройте браузер: **http://localhost:8080**
- Или запустите тест: `.\test_local_api.ps1`

### 3. Остановка туннеля

```powershell
.\stop_ssh_tunnel.ps1
```

## Требования

- **OpenSSH Client** должен быть установлен в Windows:
  - Windows 10/11: Параметры → Приложения → Дополнительные компоненты → OpenSSH Client
  - Или установите через PowerShell: `Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0`

## Параметры подключения

| Параметр | Значение |
|----------|----------|
| VDS Host | 185.185.71.248 |
| VDS User | root |
| Локальный порт | 8080 |
| Удалённый порт | 8080 (на VDS) |

## Устранение проблем

### Порт 8080 занят

Если порт 8080 уже используется другим процессом:
```powershell
# Проверить, что использует порт
Get-NetTCPConnection -LocalPort 8080 | Select-Object OwningProcess | Get-Process

# Скрипт автоматически предложит убить процесс
```

### SSH подключение не работает

1. Проверьте доступность VDS:
```powershell
ping 185.185.71.248
```

2. Проверьте SSH доступ:
```powershell
ssh root@185.185.71.248
```

3. Убедитесь, что на VDS работает веб-сервер на порту 8080:
```bash
# На VDS выполните:
curl http://localhost:8080/api/health
```

### Туннель создан, но веб-интерфейс не работает

1. Проверьте статус сервиса на VDS:
```bash
ssh root@185.185.71.248
sudo systemctl status kkt-web
sudo journalctl -u kkt-web -n 50
```

2. Проверьте nginx:
```bash
sudo systemctl status nginx
sudo nginx -t
```

## Автоматическое подключение (опционально)

Для автоматического подключения без ввода пароля настройте SSH ключ:

1. Сгенерируйте SSH ключ (если нет):
```powershell
ssh-keygen -t rsa -b 4096
```

2. Скопируйте ключ на VDS:
```powershell
type $env:USERPROFILE\.ssh\id_rsa.pub | ssh root@185.185.71.248 "cat >> ~/.ssh/authorized_keys"
```

После этого туннель будет запускаться автоматически без запроса пароля.

## Работа с карточкой клиента

После запуска туннеля:

1. Откройте браузер: `http://localhost:8080`
2. Войдите в систему (admin@kkt.local / admin123)
3. Перейдите в раздел "Клиенты"
4. Кликните на карточку клиента
5. Теперь должны отображаться:
   - Информация о клиенте
   - Кассовые аппараты
   - Текущие дедлайны
   - Формы создания касс и дедлайнов

## Полезные команды

```powershell
# Проверить активные SSH туннели
Get-Process ssh

# Проверить что слушает порт 8080
Get-NetTCPConnection -LocalPort 8080

# Убить все SSH процессы
Get-Process ssh | Stop-Process -Force

# Тест API
.\test_local_api.ps1
```

---

**Создано:** 2025-12-14  
**Версия:** 1.0  
**Проект:** KKT Service Expiration Management System
